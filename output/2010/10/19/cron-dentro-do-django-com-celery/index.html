<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <title>Cron dentro do Django com Celery</title>
        <link rel="stylesheet" href="/theme/css/main.css">
                <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Thiago Avelino Atom Feed" />
                
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a href="http://github.com/avelino">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="/">Thiago Avelino </a></h1>
                <nav><ul>
                                                                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2010/10/19/cron-dentro-do-django-com-celery" rel="bookmark"
           title="Permalink to Cron dentro do Django com Celery">Cron dentro do Django com Celery</a></h1>
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="avelino0">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2010-10-19T22:34:00">
                Tue 19 October 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="/author/avelino.html">avelino</a>
        </address>
        <p>In <a href="/category/avelino.html">Avelino</a>. </p>

</footer><!-- /.post-info -->      <p>Ontem na parte da noite conversando com um conhecido ele falou que
estava usando em um projeto o <a href="http://celeryproject.org/">Celery</a>, como ainda não conhecia vamos
estudar este projeto. Gostei da forma que ele trabalha e como ele
integra com o <a href="http://www.djangoproject.com/">Django</a>.<br />
Tenho em um projeto uma fila de processamento só que foi desenvolvido
por mim e não tem todos os recursos que o <a href="http://celeryproject.org/">Celery</a> tem.</p>
<p>Vou explicar como usar o <a href="http://celeryproject.org/">Celery</a> com o <a href="http://www.djangoproject.com/">Django</a> em um exemplo
simples, e como sempre basta usar a criatividade para desenvolver a sua
necessidade.</p>
<p>Primeiramente temos que instalar dois pacotes Python para que possamos
trabalhar com o Celery no Django, o django-celery e ghettoq. Caso
tenhamos o easy_install instalado basta instalar os pacotes da seguinte
forma:</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">easy_install</span> <span class="n">django</span><span class="o">-</span><span class="n">celery</span>
<span class="err">$</span> <span class="n">easy_install</span> <span class="n">ghettoq</span>
</pre></div>


<p>Caso não tenha vamos instalar:</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">http</span><span class="o">:</span><span class="c1">//github.com/ask/django-celery.git</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">django</span><span class="o">-</span><span class="n">celery</span>
<span class="err">$</span> <span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">build</span>
<span class="err">$</span> <span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">install</span>
<span class="err">$</span> <span class="n">cd</span> <span class="p">..</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">http</span><span class="o">:</span><span class="c1">//github.com/ask/ghettoq</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">ghettoq</span>
<span class="err">$</span> <span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">build</span>
<span class="err">$</span> <span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>


<p>Após instalar vamos criar um projeto para que possamos trabalhar com o
Celery nele.</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">django</span><span class="o">-</span><span class="n">admin</span><span class="p">.</span><span class="n">py</span> <span class="n">startproject</span> <span class="n">celerytest</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">celerytest</span>
</pre></div>


<p>Vamos editar o settings.py:</p>
<div class="highlight"><pre><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="k">default</span><span class="err">&#39;</span><span class="o">:</span> <span class="p">{</span>
        <span class="err">&#39;</span><span class="n">ENGINE</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">django</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">sqlite3</span><span class="err">&#39;</span><span class="p">,</span>
        <span class="err">&#39;</span><span class="n">NAME</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">test</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="n">CARROT_BACKEND</span> <span class="o">=</span> <span class="s">&quot;ghettoq.taproot.Database&quot;</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">...</span>
    <span class="err">&#39;</span><span class="n">djcelery</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">ghettoq</span><span class="err">&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>


<p>Após declarar qual biblioteca o projeto em Django vai carregar podemos
sincronizar o nosso database:</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">syncdb</span>
</pre></div>


<p>Temos que criar um arquivo chamado tasks.py, esse arquivo trabalha como
o models de uma aplicação:</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">celery</span><span class="p">.</span><span class="n">task</span><span class="p">.</span><span class="n">schedules</span> <span class="n">import</span> <span class="n">crontab</span>
<span class="n">from</span> <span class="n">celery</span><span class="p">.</span><span class="n">decorators</span> <span class="n">import</span> <span class="n">periodic_task</span>

<span class="cp"># this will run every minute, see http:</span><span class="c1">//celeryproject.org/docs/reference/celery.task.schedules.html#celery.task.schedules.crontab</span>
<span class="err">@</span><span class="n">periodic_task</span><span class="p">(</span><span class="n">run_every</span><span class="o">=</span><span class="n">crontab</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">day_of_week</span><span class="o">=</span><span class="s">&quot;*&quot;</span><span class="p">))</span>
<span class="n">def</span> <span class="n">test</span><span class="p">()</span><span class="o">:</span>    
    <span class="n">print</span> <span class="s">&quot;Tarefa de teste...&quot;</span>
</pre></div>


<p>Agora temos que dar start em nosso daemon Celery:</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">celeryd</span> <span class="o">-</span><span class="n">v</span> <span class="mi">2</span> <span class="o">-</span><span class="n">B</span> <span class="o">-</span><span class="n">s</span> <span class="n">celery</span> <span class="o">-</span><span class="n">E</span> <span class="o">-</span><span class="n">l</span> <span class="n">INFO</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">215</span><span class="o">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">celery</span><span class="err">@</span><span class="n">program</span><span class="o">-</span><span class="mi">8</span> <span class="n">v2</span><span class="mf">.1.1</span> <span class="n">is</span> <span class="n">starting</span><span class="p">.</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">216</span><span class="o">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.6</span><span class="o">/</span><span class="n">dist</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">celery</span><span class="o">-</span><span class="mf">2.1.1</span><span class="o">-</span><span class="n">py2</span><span class="mf">.6</span><span class="p">.</span><span class="n">egg</span><span class="o">/</span><span class="n">celery</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span>
    <span class="n">worker</span><span class="p">.</span><span class="n">py</span><span class="o">:</span><span class="mi">105</span><span class="o">:</span> <span class="n">UserWarning</span><span class="o">:</span> <span class="n">Running</span> <span class="n">celeryd</span> <span class="n">with</span> <span class="n">superuser</span> <span class="n">privileges</span> <span class="n">is</span> <span class="n">not</span> <span class="n">encouraged</span><span class="o">!</span>
  <span class="s">&quot;Running celeryd with superuser privileges is not encouraged!&quot;</span><span class="p">)</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">216</span><span class="o">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.6</span><span class="o">/</span><span class="n">dist</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">celery</span><span class="o">-</span><span class="mf">2.1.1</span><span class="o">-</span><span class="n">py2</span><span class="mf">.6</span><span class="p">.</span><span class="n">egg</span><span class="o">/</span><span class="n">celery</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span>
    <span class="n">worker</span><span class="p">.</span><span class="n">py</span><span class="o">:</span><span class="mi">108</span><span class="o">:</span> <span class="n">UserWarning</span><span class="o">:</span> <span class="n">Using</span> <span class="n">settings</span><span class="p">.</span><span class="n">DEBUG</span> <span class="n">leads</span> <span class="n">to</span> <span class="n">a</span> <span class="n">memory</span> <span class="n">leak</span><span class="p">,</span> <span class="n">never</span> <span class="n">use</span> <span class="n">this</span> <span class="n">setting</span> <span class="n">in</span> <span class="n">a</span> <span class="n">production</span> <span class="n">environment</span><span class="o">!</span>
  <span class="n">warnings</span><span class="p">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Using settings.DEBUG leads to a memory leak, &quot;</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">222</span><span class="o">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span>  
<span class="n">Configuration</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span>
    <span class="p">.</span> <span class="n">broker</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">ghettoq</span><span class="p">.</span><span class="n">taproot</span><span class="p">.</span><span class="n">Database</span><span class="o">:</span><span class="c1">//guest@localhost/</span>
    <span class="p">.</span> <span class="n">queues</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span>
        <span class="p">.</span> <span class="n">celery</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">exchange</span><span class="o">:</span><span class="n">celery</span> <span class="p">(</span><span class="n">direct</span><span class="p">)</span> <span class="n">binding</span><span class="o">:</span><span class="n">celery</span>
    <span class="p">.</span> <span class="n">concurrency</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">2</span>
    <span class="p">.</span> <span class="n">loader</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">djcelery</span><span class="p">.</span><span class="n">loaders</span><span class="p">.</span><span class="n">DjangoLoader</span>
    <span class="p">.</span> <span class="n">logfile</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="p">[</span><span class="n">stderr</span><span class="p">]</span><span class="err">@</span><span class="n">INFO</span>
    <span class="p">.</span> <span class="n">events</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">ON</span>
    <span class="p">.</span> <span class="n">beat</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">ON</span>
    <span class="p">.</span> <span class="n">tasks</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span>
 <span class="p">.</span> <span class="n">celerytest</span><span class="p">.</span><span class="n">lol</span><span class="p">.</span><span class="n">tasks</span><span class="p">.</span><span class="n">test</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">238</span><span class="o">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">PoolWorker</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="n">child</span> <span class="n">process</span> <span class="n">calling</span> <span class="n">self</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">239</span><span class="o">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">PoolWorker</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="n">child</span> <span class="n">process</span> <span class="n">calling</span> <span class="n">self</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">241</span><span class="o">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">celery</span><span class="err">@</span><span class="n">program</span><span class="o">-</span><span class="mi">8</span> <span class="n">has</span> <span class="n">started</span><span class="p">.</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">241</span><span class="o">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">Beat</span><span class="p">]</span> <span class="n">child</span> <span class="n">process</span> <span class="n">calling</span> <span class="n">self</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">241</span><span class="o">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">Beat</span><span class="p">]</span> <span class="n">Celerybeat</span><span class="o">:</span> <span class="n">Starting</span><span class="p">...</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mo">00</span><span class="p">,</span><span class="mi">537</span><span class="o">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Got</span> <span class="n">task</span> <span class="n">from</span> <span class="n">broker</span><span class="o">:</span> <span class="n">celerytest</span><span class="p">.</span><span class="n">lol</span><span class="p">.</span><span class="n">tasks</span><span class="p">.</span><span class="n">test</span><span class="p">[</span><span class="mi">22</span><span class="n">d15af7</span><span class="o">-</span><span class="mf">8f</span><span class="n">e9</span><span class="o">-</span><span class="mi">4</span><span class="n">acd</span><span class="o">-</span><span class="n">bdde</span><span class="o">-</span><span class="mo">06265004</span><span class="n">eb50</span><span class="p">]</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mo">00</span><span class="p">,</span><span class="mi">760</span><span class="o">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">PoolWorker</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="n">firing</span> <span class="n">test</span> <span class="n">task</span>
<span class="p">[</span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mo">05</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mo">01</span><span class="p">,</span><span class="mi">088</span><span class="o">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Task</span> <span class="n">celerytest</span><span class="p">.</span><span class="n">lol</span><span class="p">.</span><span class="n">tasks</span><span class="p">.</span><span class="n">test</span><span class="p">[</span><span class="mi">22</span><span class="n">d15af7</span><span class="o">-</span><span class="mf">8f</span><span class="n">e9</span><span class="o">-</span><span class="mi">4</span><span class="n">acd</span><span class="o">-</span><span class="n">bdde</span><span class="o">-</span><span class="mo">06265004</span><span class="n">eb50</span><span class="p">]</span> <span class="n">processed</span><span class="o">:</span> <span class="n">None</span>
</pre></div>


<p>Pronto ele esta rodando.</p>
<p>O <a href="http://celeryproject.org/">Celery</a> é um projeto muito bom só que ainda estamos enfrentando
alguns bugs com processos pesado o pior que ele para de processar e não
esta dando nem um retorno, por isso antes colocar em produção teste sua
aplicação onde o <a href="http://celeryproject.org/">Celery</a> vai rodar.</p>
    </div><!-- /.entry-content -->
    
  </article>
</section>
        <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://getpelican.com/">Pelican</a></li>
                                                    <li><a href="http://python.org/">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                                                    <li><a href="#">You can modify those links in your config file</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/rss.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://twitter.com/avelino0">twitter</a></li>
                                                    <li><a href="http://github.com/avelino">github</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>